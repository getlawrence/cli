// OpenTelemetry bootstrap for {{.ServiceName}} (.NET)

using Microsoft.Extensions.DependencyInjection;
using OpenTelemetry;
using OpenTelemetry.Trace;
using OpenTelemetry.Resources;
using OpenTelemetry.Context.Propagation;

public static class Otel
{
    public static void Configure(IServiceCollection services)
    {
        var endpoint = Environment.GetEnvironmentVariable("OTEL_EXPORTER_OTLP_ENDPOINT") ?? "{{if .TraceEndpoint}}{{.TraceEndpoint}}{{else}}http://localhost:4318{{end}}";

        services.AddOpenTelemetry()
            .WithTracing(tracing => tracing
                .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("{{.ServiceName}}"))
                .AddAspNetCoreInstrumentation()
                .AddHttpClientInstrumentation()
                .AddGrpcClientInstrumentation()
                .AddRuntimeInstrumentation()
                .AddProcessInstrumentation()
                .SetSampler(new TraceIdRatioBasedSampler({{if gt .SamplerRatio 0.0}}{{.SamplerRatio}}{{else}}1.0{{end}}))
                .AddOtlpExporter(o => {
                    o.Endpoint = new Uri(endpoint);
                }));

        // Propagators (defaults: TraceContext + Baggage)
        Sdk.SetDefaultTextMapPropagator(new CompositeTextMapPropagator(new TextMapPropagator[] {
            new TraceContextPropagator(),
            new BaggagePropagator()
        }));
    }
}


